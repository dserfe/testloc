{"model_name_or_path": "agentless_claude", "instance_id": "django__django-16032", "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 006c631..b3ba9a9 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -276,10 +276,12 @@ class SQLCompiler:\n                 \"model\": self.query.model,\n                 \"select_fields\": select_list,\n             }\n+        # Only include annotations that aren't aliased when this query is used as a subquery\n         for alias, annotation in self.query.annotation_select.items():\n-            annotations[alias] = select_idx\n-            select.append((annotation, alias))\n-            select_idx += 1\n+            if not (self.query.subquery and alias in self.query.alias_map):\n+                annotations[alias] = select_idx\n+                select.append((annotation, alias))\n+                select_idx += 1\n \n         if self.query.select_related:\n             related_klass_infos = self.get_related_selections(select, select_mask)\n", "occurrence": 1, "normalized_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex e16cf4a..ae51861 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -120,9 +120,10 @@ class SQLCompiler:\n                 select_idx += 1\n             klass_info = {'model': self.query.model, 'select_fields': select_list}\n         for alias, annotation in self.query.annotation_select.items():\n-            annotations[alias] = select_idx\n-            select.append((annotation, alias))\n-            select_idx += 1\n+            if not (self.query.subquery and alias in self.query.alias_map):\n+                annotations[alias] = select_idx\n+                select.append((annotation, alias))\n+                select_idx += 1\n         if self.query.select_related:\n             related_klass_infos = self.get_related_selections(select, select_mask)\n             klass_info['related_klass_infos'] = related_klass_infos\n", "normalized_occurrence": 1}
