{"model_name_or_path": "agentless_claude", "instance_id": "sympy__sympy-13915", "model_patch": "diff --git a/sympy/core/basic.py b/sympy/core/basic.py\nindex 0977e81..6d34caf 100644\n--- a/sympy/core/basic.py\n+++ b/sympy/core/basic.py\n@@ -898,7 +898,13 @@ class Basic(with_metaclass(ManagedProperties)):\n                 sequence = sorted([(k, v) for (k, v) in sequence.items()],\n                                   key=default_sort_key)\n \n-        if kwargs.pop('simultaneous', False):  # XXX should this be the default for dict subs?\n+        simultaneous = kwargs.pop('simultaneous', None)\n+        if simultaneous is None:\n+            # Use simultaneous substitution if substituting a symbol with itself\n+            # or if any substitution could lead to undefined expressions\n+            simultaneous = any(old == new or (isinstance(old, Symbol) and old in new.free_symbols)\n+                             for old, new in sequence)\n+        if simultaneous:\n             reps = {}\n             rv = self\n             kwargs['hack2'] = True\n", "occurrence": 1, "normalized_patch": "diff --git a/sympy/core/basic.py b/sympy/core/basic.py\nindex 782db85..1d0a598 100644\n--- a/sympy/core/basic.py\n+++ b/sympy/core/basic.py\n@@ -310,7 +310,10 @@ class Basic(with_metaclass(ManagedProperties)):\n                 del newseq, d\n             else:\n                 sequence = sorted([(k, v) for k, v in sequence.items()], key=default_sort_key)\n-        if kwargs.pop('simultaneous', False):\n+        simultaneous = kwargs.pop('simultaneous', None)\n+        if simultaneous is None:\n+            simultaneous = any((old == new or (isinstance(old, Symbol) and old in new.free_symbols) for old, new in sequence))\n+        if simultaneous:\n             reps = {}\n             rv = self\n             kwargs['hack2'] = True\n", "normalized_occurrence": 1}
