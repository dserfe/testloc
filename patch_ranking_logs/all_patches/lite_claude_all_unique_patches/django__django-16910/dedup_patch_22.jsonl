{"model_name_or_path": "agentless_claude", "instance_id": "django__django-16910", "model_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 9d8d506..9478d7e 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -778,8 +778,19 @@ class Query(BaseExpression):\n         select_mask[opts.pk] = {}\n         # Only include fields mentioned in the mask.\n         for field_name, field_mask in mask.items():\n-            field = opts.get_field(field_name)\n-            field_select_mask = select_mask.setdefault(field, {})\n+            if filtered_relation := self._filtered_relations.get(field_name):\n+                relation = opts.get_field(filtered_relation.relation_name)\n+                field_select_mask = select_mask.setdefault((field_name, relation), {})\n+                field = relation.field\n+            else:\n+                if \"__\" in field_name:\n+                    # Handle reverse relations by getting the related field\n+                    field = opts.get_field(field_name.split(\"__\")[0])\n+                    if hasattr(field, \"field\"):  # Reverse relation\n+                        field = field.field\n+                else:\n+                    field = opts.get_field(field_name)\n+                field_select_mask = select_mask.setdefault(field, {})\n             if field_mask:\n                 if not field.is_relation:\n                     raise FieldError(next(iter(field_mask)))\n", "occurrence": 1, "normalized_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex f8d5b2d..28905d4 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -413,8 +413,18 @@ class Query(BaseExpression):\n             select_mask = {}\n         select_mask[opts.pk] = {}\n         for field_name, field_mask in mask.items():\n-            field = opts.get_field(field_name)\n-            field_select_mask = select_mask.setdefault(field, {})\n+            if (filtered_relation := self._filtered_relations.get(field_name)):\n+                relation = opts.get_field(filtered_relation.relation_name)\n+                field_select_mask = select_mask.setdefault((field_name, relation), {})\n+                field = relation.field\n+            else:\n+                if '__' in field_name:\n+                    field = opts.get_field(field_name.split('__')[0])\n+                    if hasattr(field, 'field'):\n+                        field = field.field\n+                else:\n+                    field = opts.get_field(field_name)\n+                field_select_mask = select_mask.setdefault(field, {})\n             if field_mask:\n                 if not field.is_relation:\n                     raise FieldError(next(iter(field_mask)))\n", "normalized_occurrence": 1}
