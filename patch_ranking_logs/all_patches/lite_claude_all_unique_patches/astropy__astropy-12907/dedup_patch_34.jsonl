{"model_name_or_path": "agentless_claude", "instance_id": "astropy__astropy-12907", "model_patch": "diff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\nindex d6e9246..d95c497 100644\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -207,12 +207,25 @@ def _coord_matrix(model, pos, noutp):\n         else:\n             mat[-model.n_outputs:, -model.n_inputs:] = 1\n     else:\n-        mat = np.zeros((noutp, model.n_inputs))\n-\n-        for i in range(model.n_inputs):\n-            mat[i, i] = 1\n-        if pos == 'right':\n-            mat = np.roll(mat, (noutp - model.n_outputs))\n+        if isinstance(model, CompoundModel):\n+            # Handle nested compound models by getting their separability matrix\n+            mat = separability_matrix(model)\n+            # Embed the matrix in a larger matrix if needed\n+            if pos == 'right':\n+                new_mat = np.zeros((noutp, model.n_inputs))\n+                new_mat[-model.n_outputs:, -model.n_inputs:] = mat\n+                mat = new_mat\n+            else:\n+                new_mat = np.zeros((noutp, model.n_inputs))\n+                new_mat[:model.n_outputs, :model.n_inputs] = mat\n+                mat = new_mat\n+        else:\n+            # For simple separable models, create a diagonal matrix\n+            mat = np.zeros((noutp, model.n_inputs))\n+            for i in range(model.n_inputs):\n+                mat[i, i] = 1\n+            if pos == 'right':\n+                mat = np.roll(mat, (noutp - model.n_outputs))\n     return mat\n \n \n", "occurrence": 1, "normalized_patch": "diff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\nindex 198a838..4c333db 100644\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -60,6 +60,16 @@ def _coord_matrix(model, pos, noutp):\n             mat[:model.n_outputs, :model.n_inputs] = 1\n         else:\n             mat[-model.n_outputs:, -model.n_inputs:] = 1\n+    elif isinstance(model, CompoundModel):\n+        mat = separability_matrix(model)\n+        if pos == 'right':\n+            new_mat = np.zeros((noutp, model.n_inputs))\n+            new_mat[-model.n_outputs:, -model.n_inputs:] = mat\n+            mat = new_mat\n+        else:\n+            new_mat = np.zeros((noutp, model.n_inputs))\n+            new_mat[:model.n_outputs, :model.n_inputs] = mat\n+            mat = new_mat\n     else:\n         mat = np.zeros((noutp, model.n_inputs))\n         for i in range(model.n_inputs):\n", "normalized_occurrence": 1}
