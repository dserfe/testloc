{"model_name_or_path": "agentless_claude", "instance_id": "matplotlib__matplotlib-25442", "model_patch": "diff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py\nindex db0cc2e..6d7ab3d 100644\n--- a/lib/matplotlib/offsetbox.py\n+++ b/lib/matplotlib/offsetbox.py\n@@ -1499,16 +1499,29 @@ class DraggableBase:\n         if not ref_artist.pickable():\n             ref_artist.set_picker(True)\n         self.got_artist = False\n-        self._use_blit = use_blit and self.canvas.supports_blit\n-        self.cids = [\n-            self.canvas.callbacks._connect_picklable(\n-                'pick_event', self.on_pick),\n-            self.canvas.callbacks._connect_picklable(\n-                'button_release_event', self.on_release),\n-        ]\n+        \n+        # Cache the canvas reference for cleanup\n+        self._canvas = ref_artist.figure.canvas if ref_artist.figure is not None else None\n+        \n+        if self._canvas is not None:\n+            self._use_blit = use_blit and self._canvas.supports_blit\n+            self.cids = [\n+                self._canvas.callbacks._connect_picklable(\n+                    'pick_event', self.on_pick),\n+                self._canvas.callbacks._connect_picklable(\n+                    'button_release_event', self.on_release),\n+            ]\n+        else:\n+            self._use_blit = False\n+            self.cids = []\n \n     # A property, not an attribute, to maintain picklability.\n-    canvas = property(lambda self: self.ref_artist.figure.canvas)\n+    @property\n+    def canvas(self):\n+        # First try to get the current canvas\n+        if self.ref_artist.figure is not None:\n+            self._canvas = self.ref_artist.figure.canvas\n+        return self._canvas\n \n     def on_motion(self, evt):\n         if self._check_still_parented() and self.got_artist:\n@@ -1558,14 +1571,15 @@ class DraggableBase:\n \n     def disconnect(self):\n         \"\"\"Disconnect the callbacks.\"\"\"\n-        for cid in self.cids:\n-            self.canvas.mpl_disconnect(cid)\n-        try:\n-            c1 = self._c1\n-        except AttributeError:\n-            pass\n-        else:\n-            self.canvas.mpl_disconnect(c1)\n+        if self._canvas is not None:\n+            for cid in self.cids:\n+                self._canvas.mpl_disconnect(cid)\n+            try:\n+                c1 = self._c1\n+            except AttributeError:\n+                pass\n+            else:\n+                self._canvas.mpl_disconnect(c1)\n \n     def save_offset(self):\n         pass\n", "occurrence": 1, "normalized_patch": "diff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py\nindex f94319f..b2ac6e3 100644\n--- a/lib/matplotlib/offsetbox.py\n+++ b/lib/matplotlib/offsetbox.py\n@@ -1262,9 +1262,19 @@ class DraggableBase:\n         if not ref_artist.pickable():\n             ref_artist.set_picker(True)\n         self.got_artist = False\n-        self._use_blit = use_blit and self.canvas.supports_blit\n-        self.cids = [self.canvas.callbacks._connect_picklable('pick_event', self.on_pick), self.canvas.callbacks._connect_picklable('button_release_event', self.on_release)]\n-    canvas = property(lambda self: self.ref_artist.figure.canvas)\n+        self._canvas = ref_artist.figure.canvas if ref_artist.figure is not None else None\n+        if self._canvas is not None:\n+            self._use_blit = use_blit and self._canvas.supports_blit\n+            self.cids = [self._canvas.callbacks._connect_picklable('pick_event', self.on_pick), self._canvas.callbacks._connect_picklable('button_release_event', self.on_release)]\n+        else:\n+            self._use_blit = False\n+            self.cids = []\n+\n+    @property\n+    def canvas(self):\n+        if self.ref_artist.figure is not None:\n+            self._canvas = self.ref_artist.figure.canvas\n+        return self._canvas\n \n     def on_motion(self, evt):\n         if self._check_still_parented() and self.got_artist:\n@@ -1309,14 +1319,15 @@ class DraggableBase:\n \n     def disconnect(self):\n         \"\"\"Disconnect the callbacks.\"\"\"\n-        for cid in self.cids:\n-            self.canvas.mpl_disconnect(cid)\n-        try:\n-            c1 = self._c1\n-        except AttributeError:\n-            pass\n-        else:\n-            self.canvas.mpl_disconnect(c1)\n+        if self._canvas is not None:\n+            for cid in self.cids:\n+                self._canvas.mpl_disconnect(cid)\n+            try:\n+                c1 = self._c1\n+            except AttributeError:\n+                pass\n+            else:\n+                self._canvas.mpl_disconnect(c1)\n \n     def save_offset(self):\n         pass\n", "normalized_occurrence": 1}
