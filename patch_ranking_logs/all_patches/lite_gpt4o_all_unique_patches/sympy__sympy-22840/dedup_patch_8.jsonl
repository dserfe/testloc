{"model_name_or_path": "agentless", "instance_id": "sympy__sympy-22840", "model_patch": "diff --git a/sympy/simplify/cse_main.py b/sympy/simplify/cse_main.py\nindex fa99708..243528d 100644\n--- a/sympy/simplify/cse_main.py\n+++ b/sympy/simplify/cse_main.py\n@@ -671,9 +671,15 @@ def tree_cse(exprs, symbols, opt_subs=None, order='canonical', ignore=()):\n             except StopIteration:\n                 raise ValueError(\"Symbols iterator ran out of symbols.\")\n \n-            if isinstance(orig_expr, MatrixExpr):\n-                sym = MatrixSymbol(sym.name, orig_expr.rows,\n-                    orig_expr.cols)\n+            if isinstance(orig_expr, MatrixSymbol):\n+                row, col = orig_expr.shape\n+                for i in range(row):\n+                    for j in range(col):\n+                        elem = orig_expr[i, j]\n+                        sym_elem = MatrixElement(sym, i, j)\n+                        subs[elem] = sym_elem\n+                        replacements.append((sym_elem, new_expr[i, j]))\n+                return sym\n \n             subs[orig_expr] = sym\n             replacements.append((sym, new_expr))\n", "occurrence": 1, "normalized_patch": "diff --git a/sympy/simplify/cse_main.py b/sympy/simplify/cse_main.py\nindex d5cc8d7..8df2713 100644\n--- a/sympy/simplify/cse_main.py\n+++ b/sympy/simplify/cse_main.py\n@@ -287,8 +287,15 @@ def tree_cse(exprs, symbols, opt_subs=None, order='canonical', ignore=()):\n                 sym = next(symbols)\n             except StopIteration:\n                 raise ValueError('Symbols iterator ran out of symbols.')\n-            if isinstance(orig_expr, MatrixExpr):\n-                sym = MatrixSymbol(sym.name, orig_expr.rows, orig_expr.cols)\n+            if isinstance(orig_expr, MatrixSymbol):\n+                row, col = orig_expr.shape\n+                for i in range(row):\n+                    for j in range(col):\n+                        elem = orig_expr[i, j]\n+                        sym_elem = MatrixElement(sym, i, j)\n+                        subs[elem] = sym_elem\n+                        replacements.append((sym_elem, new_expr[i, j]))\n+                return sym\n             subs[orig_expr] = sym\n             replacements.append((sym, new_expr))\n             return sym\n", "normalized_occurrence": 1}
