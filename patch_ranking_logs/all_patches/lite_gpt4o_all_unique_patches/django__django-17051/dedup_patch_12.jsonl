{"model_name_or_path": "agentless", "instance_id": "django__django-17051", "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 364ef3b..a2f8516 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -1775,7 +1775,7 @@ class SQLInsertCompiler(SQLCompiler):\n         if (\n             self.returning_fields\n             and self.connection.features.can_return_columns_from_insert\n-        ):\n+        ) or self.query.on_conflict == OnConflict.UPDATE:\n             if self.connection.features.can_return_rows_from_bulk_insert:\n                 result.append(\n                     self.connection.ops.bulk_insert_sql(fields, placeholder_rows)\n@@ -1788,12 +1788,13 @@ class SQLInsertCompiler(SQLCompiler):\n                 result.append(on_conflict_suffix_sql)\n             # Skip empty r_sql to allow subclasses to customize behavior for\n             # 3rd party backends. Refs #19096.\n-            r_sql, self.returning_params = self.connection.ops.return_insert_columns(\n-                self.returning_fields\n-            )\n-            if r_sql:\n-                result.append(r_sql)\n-                params += [self.returning_params]\n+            if self.returning_fields:\n+                r_sql, self.returning_params = self.connection.ops.return_insert_columns(\n+                    self.returning_fields\n+                )\n+                if r_sql:\n+                    result.append(r_sql)\n+                    params += [self.returning_params]\n             return [(\" \".join(result), tuple(chain.from_iterable(params)))]\n \n         if can_bulk:\n", "occurrence": 1, "normalized_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 802130c..68774d7 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -875,7 +875,7 @@ class SQLInsertCompiler(SQLCompiler):\n         can_bulk = not self.returning_fields and self.connection.features.has_bulk_insert\n         placeholder_rows, param_rows = self.assemble_as_sql(fields, value_rows)\n         on_conflict_suffix_sql = self.connection.ops.on_conflict_suffix_sql(fields, self.query.on_conflict, (f.column for f in self.query.update_fields), (f.column for f in self.query.unique_fields))\n-        if self.returning_fields and self.connection.features.can_return_columns_from_insert:\n+        if self.returning_fields and self.connection.features.can_return_columns_from_insert or self.query.on_conflict == OnConflict.UPDATE:\n             if self.connection.features.can_return_rows_from_bulk_insert:\n                 result.append(self.connection.ops.bulk_insert_sql(fields, placeholder_rows))\n                 params = param_rows\n@@ -884,10 +884,11 @@ class SQLInsertCompiler(SQLCompiler):\n                 params = [param_rows[0]]\n             if on_conflict_suffix_sql:\n                 result.append(on_conflict_suffix_sql)\n-            r_sql, self.returning_params = self.connection.ops.return_insert_columns(self.returning_fields)\n-            if r_sql:\n-                result.append(r_sql)\n-                params += [self.returning_params]\n+            if self.returning_fields:\n+                r_sql, self.returning_params = self.connection.ops.return_insert_columns(self.returning_fields)\n+                if r_sql:\n+                    result.append(r_sql)\n+                    params += [self.returning_params]\n             return [(' '.join(result), tuple(chain.from_iterable(params)))]\n         if can_bulk:\n             result.append(self.connection.ops.bulk_insert_sql(fields, placeholder_rows))\n", "normalized_occurrence": 1}
