{"model_name_or_path": "agentless_claude", "instance_id": "django__django-16100", "model_patch": "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex 32995ac..c31977a 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -2011,25 +2011,32 @@ class ModelAdmin(BaseModelAdmin):\n             )\n             if formset.is_valid():\n                 changecount = 0\n-                for form in formset.forms:\n-                    if form.has_changed():\n-                        obj = self.save_form(request, form, change=True)\n-                        self.save_model(request, obj, form, change=True)\n-                        self.save_related(request, form, formsets=[], change=True)\n-                        change_msg = self.construct_change_message(request, form, None)\n-                        self.log_change(request, obj, change_msg)\n-                        changecount += 1\n-\n-                if changecount:\n-                    msg = ngettext(\n-                        \"%(count)s %(name)s was changed successfully.\",\n-                        \"%(count)s %(name)s were changed successfully.\",\n-                        changecount,\n-                    ) % {\n-                        \"count\": changecount,\n-                        \"name\": model_ngettext(self.opts, changecount),\n-                    }\n-                    self.message_user(request, msg, messages.SUCCESS)\n+                from django.db import transaction\n+                try:\n+                    with transaction.atomic():\n+                        for form in formset.forms:\n+                            if form.has_changed():\n+                                obj = self.save_form(request, form, change=True)\n+                                self.save_model(request, obj, form, change=True)\n+                                self.save_related(request, form, formsets=[], change=True)\n+                                change_msg = self.construct_change_message(request, form, None)\n+                                self.log_change(request, obj, change_msg)\n+                                changecount += 1\n+\n+                        if changecount:\n+                            msg = ngettext(\n+                                \"%(count)s %(name)s was changed successfully.\",\n+                                \"%(count)s %(name)s were changed successfully.\",\n+                                changecount,\n+                            ) % {\n+                                \"count\": changecount,\n+                                \"name\": model_ngettext(self.opts, changecount),\n+                            }\n+                            self.message_user(request, msg, messages.SUCCESS)\n+                except Exception as e:\n+                    msg = _(\"An error occurred while saving. No items were changed.\")\n+                    self.message_user(request, msg, messages.ERROR)\n+                    return HttpResponseRedirect(request.get_full_path())\n \n                 return HttpResponseRedirect(request.get_full_path())\n \n", "occurrence": 1, "normalized_patch": "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex 6c1421c..6581a35 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -856,17 +856,24 @@ class ModelAdmin(BaseModelAdmin):\n             formset = cl.formset = FormSet(request.POST, request.FILES, queryset=modified_objects)\n             if formset.is_valid():\n                 changecount = 0\n-                for form in formset.forms:\n-                    if form.has_changed():\n-                        obj = self.save_form(request, form, change=True)\n-                        self.save_model(request, obj, form, change=True)\n-                        self.save_related(request, form, formsets=[], change=True)\n-                        change_msg = self.construct_change_message(request, form, None)\n-                        self.log_change(request, obj, change_msg)\n-                        changecount += 1\n-                if changecount:\n-                    msg = ngettext('%(count)s %(name)s was changed successfully.', '%(count)s %(name)s were changed successfully.', changecount) % {'count': changecount, 'name': model_ngettext(self.opts, changecount)}\n-                    self.message_user(request, msg, messages.SUCCESS)\n+                from django.db import transaction\n+                try:\n+                    with transaction.atomic():\n+                        for form in formset.forms:\n+                            if form.has_changed():\n+                                obj = self.save_form(request, form, change=True)\n+                                self.save_model(request, obj, form, change=True)\n+                                self.save_related(request, form, formsets=[], change=True)\n+                                change_msg = self.construct_change_message(request, form, None)\n+                                self.log_change(request, obj, change_msg)\n+                                changecount += 1\n+                        if changecount:\n+                            msg = ngettext('%(count)s %(name)s was changed successfully.', '%(count)s %(name)s were changed successfully.', changecount) % {'count': changecount, 'name': model_ngettext(self.opts, changecount)}\n+                            self.message_user(request, msg, messages.SUCCESS)\n+                except Exception as e:\n+                    msg = _('An error occurred while saving. No items were changed.')\n+                    self.message_user(request, msg, messages.ERROR)\n+                    return HttpResponseRedirect(request.get_full_path())\n                 return HttpResponseRedirect(request.get_full_path())\n         elif cl.list_editable and self.has_change_permission(request):\n             FormSet = self.get_changelist_formset(request)\n", "normalized_occurrence": 1}
