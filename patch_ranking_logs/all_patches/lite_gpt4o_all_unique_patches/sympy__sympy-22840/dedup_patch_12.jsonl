{"model_name_or_path": "agentless", "instance_id": "sympy__sympy-22840", "model_patch": "diff --git a/sympy/simplify/cse_main.py b/sympy/simplify/cse_main.py\nindex fa99708..348ff01 100644\n--- a/sympy/simplify/cse_main.py\n+++ b/sympy/simplify/cse_main.py\n@@ -787,7 +787,10 @@ def cse(exprs, symbols=None, optimizations=None, postprocess=None,\n     if isinstance(exprs, (Basic, MatrixBase)):\n         exprs = [exprs]\n \n+    from sympy.matrices.expressions.matexpr import MatrixSymbol\n+\n     copy = exprs\n+    matrix_symbols = {s for s in exprs if isinstance(s, MatrixSymbol)}\n     temp = []\n     for e in exprs:\n         if isinstance(e, (Matrix, ImmutableMatrix)):\n@@ -829,6 +832,9 @@ def cse(exprs, symbols=None, optimizations=None, postprocess=None,\n     reduced_exprs = [postprocess_for_cse(e, optimizations)\n                      for e in reduced_exprs]\n \n+    # Filter out MatrixSymbols from replacements\n+    replacements = [(sym, subtree) for sym, subtree in replacements if sym not in matrix_symbols]\n+\n     # Get the matrices back\n     for i, e in enumerate(exprs):\n         if isinstance(e, (Matrix, ImmutableMatrix)):\n", "occurrence": 1, "normalized_patch": "diff --git a/sympy/simplify/cse_main.py b/sympy/simplify/cse_main.py\nindex d5cc8d7..88c9652 100644\n--- a/sympy/simplify/cse_main.py\n+++ b/sympy/simplify/cse_main.py\n@@ -310,7 +310,9 @@ def cse(exprs, symbols=None, optimizations=None, postprocess=None, order='canoni\n         exprs = sympify(exprs)\n     if isinstance(exprs, (Basic, MatrixBase)):\n         exprs = [exprs]\n+    from sympy.matrices.expressions.matexpr import MatrixSymbol\n     copy = exprs\n+    matrix_symbols = {s for s in exprs if isinstance(s, MatrixSymbol)}\n     temp = []\n     for e in exprs:\n         if isinstance(e, (Matrix, ImmutableMatrix)):\n@@ -337,6 +339,7 @@ def cse(exprs, symbols=None, optimizations=None, postprocess=None, order='canoni\n         subtree = postprocess_for_cse(subtree, optimizations)\n         replacements[i] = (sym, subtree)\n     reduced_exprs = [postprocess_for_cse(e, optimizations) for e in reduced_exprs]\n+    replacements = [(sym, subtree) for sym, subtree in replacements if sym not in matrix_symbols]\n     for i, e in enumerate(exprs):\n         if isinstance(e, (Matrix, ImmutableMatrix)):\n             reduced_exprs[i] = Matrix(e.rows, e.cols, reduced_exprs[i])\n", "normalized_occurrence": 1}
