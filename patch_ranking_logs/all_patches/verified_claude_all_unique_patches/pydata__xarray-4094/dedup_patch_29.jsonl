{"model_name_or_path": "agentless_claude", "instance_id": "pydata__xarray-4094", "model_patch": "diff --git a/xarray/core/dataarray.py b/xarray/core/dataarray.py\nindex d48a6e6..c122111 100644\n--- a/xarray/core/dataarray.py\n+++ b/xarray/core/dataarray.py\n@@ -1961,7 +1961,14 @@ class DataArray(AbstractArray, DataWithCoords):\n         # pull variables out of datarray\n         data_dict = {}\n         for k in variables:\n-            data_dict[k] = self.sel({variable_dim: k}).squeeze(drop=True)\n+            # Get indices where this variable exists (not -1)\n+            valid_labels = [i for i, x in enumerate(idx.labels[level_number]) if x != -1]\n+            if valid_labels:\n+                # Only select if there are valid labels\n+                data_dict[k] = self.isel({dim: valid_labels}).sel({variable_dim: k}).squeeze(drop=True)\n+            else:\n+                # If no valid labels, this variable had no dimension for stacking\n+                data_dict[k] = self.sel({variable_dim: k}).squeeze(drop=True)\n \n         # unstacked dataset\n         return Dataset(data_dict)\n", "occurrence": 1, "normalized_patch": "diff --git a/xarray/core/dataarray.py b/xarray/core/dataarray.py\nindex 3d86f26..fe44906 100644\n--- a/xarray/core/dataarray.py\n+++ b/xarray/core/dataarray.py\n@@ -534,7 +534,11 @@ class DataArray(AbstractArray, DataWithCoords):\n         variable_dim = idx.names[level_number]\n         data_dict = {}\n         for k in variables:\n-            data_dict[k] = self.sel({variable_dim: k}).squeeze(drop=True)\n+            valid_labels = [i for i, x in enumerate(idx.labels[level_number]) if x != -1]\n+            if valid_labels:\n+                data_dict[k] = self.isel({dim: valid_labels}).sel({variable_dim: k}).squeeze(drop=True)\n+            else:\n+                data_dict[k] = self.sel({variable_dim: k}).squeeze(drop=True)\n         return Dataset(data_dict)\n     def transpose(self, *dims: Hashable, transpose_coords: bool=True) -> 'DataArray':\n         if dims:\n", "normalized_occurrence": 1}
